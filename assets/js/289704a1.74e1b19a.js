"use strict";(self.webpackChunk_yuants_docs=self.webpackChunk_yuants_docs||[]).push([[2119],{8501:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>d,frontMatter:()=>s,metadata:()=>a,toc:()=>c});var i=t(9541),o=t(4317);const s={sidebar_position:2},r="Network Layer",a={id:"protocol/network-layer",title:"Network Layer",description:"The Host is a WebSocket server that listens for incoming connections from Terminals.",source:"@site/docs/protocol/network-layer.md",sourceDirName:"protocol",slug:"/protocol/network-layer",permalink:"/docs/protocol/network-layer",draft:!1,unlisted:!1,editUrl:"https://github.com/No-Trade-No-Life/Yuan/tree/main/ui/docs/docs/protocol/network-layer.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"docsSidebar",previous:{title:"Introduction",permalink:"/docs/protocol/introduce"},next:{title:"Message Mode Layer",permalink:"/docs/protocol/message-pattern-layer"}},l={},c=[{value:"Security",id:"security",level:3},{value:"Terminal Information",id:"terminal-information",level:3},{value:"Message Structure",id:"message-structure",level:3},{value:"Optimization",id:"optimization",level:2},{value:"Optimization: P2P Direct Connection",id:"optimization-p2p-direct-connection",level:3},{value:"Optimization: Local Loopback",id:"optimization-local-loopback",level:3}];function h(e){const n={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"network-layer",children:"Network Layer"}),"\n",(0,i.jsx)(n.p,{children:"The Host is a WebSocket server that listens for incoming connections from Terminals."}),"\n",(0,i.jsx)(n.p,{children:"The Terminal is a WebSocket client that connects to the Host."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"This document describes how Hosts and Terminals establish connections and how Terminals exchange information with each other."})}),"\n",(0,i.jsx)(n.p,{children:"Hosts are typically accessible over the internet, while Terminals are usually located within local networks and are not accessible from the internet. Therefore, Terminals can connect to Hosts and transmit messages to each other through the Host."}),"\n",(0,i.jsx)(n.p,{children:"Terminals are peer-to-peer and can be considered as a P2P network."}),"\n",(0,i.jsx)(n.p,{children:"The Host is a dumb component that merely forwards messages between Terminals. Terminals, on the other hand, are intelligent components that can process messages."}),"\n",(0,i.jsx)(n.h3,{id:"security",children:"Security"}),"\n",(0,i.jsx)(n.p,{children:"Hosts are typically accessible over the internet."}),"\n",(0,i.jsx)(n.p,{children:"It is strongly recommended to deploy TLS certificates and use the WSS protocol to encrypt communications between Terminals and Hosts."}),"\n",(0,i.jsx)(n.p,{children:"The Host has a basic token authentication mechanism to prevent unauthorized internet access."}),"\n",(0,i.jsx)(n.p,{children:"When a Terminal connects to a Host, it needs to provide a token. The token is a predefined string when the Host is deployed."}),"\n",(0,i.jsxs)(n.p,{children:["The Terminal needs to provide the ",(0,i.jsx)(n.code,{children:"host_token"})," in the query string of the URL when connecting to the Host, along with its own ",(0,i.jsx)(n.code,{children:"terminal_id"}),". For example:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"wss://api.ntnl.io/hosts?host_id=amazing_host&host_token=very_long_token&terminal_id=your_terminal_id\n"})}),"\n",(0,i.jsx)(n.p,{children:"Security and efficiency are often at odds. More stringent security means more verification calculations, which will inevitably lead to a decrease in communication efficiency.\nWe choose to sacrifice internal security of the Host to improve efficiency. Higher efficiency means saving your startup capital."}),"\n",(0,i.jsx)(n.p,{children:"The Host is the security boundary of the system. It is assumed that the internal of the Host is secure and trustworthy.\nTerminals default to trust other Terminals within the Host and do not need to verify their identities."}),"\n",(0,i.jsx)(n.p,{children:"The best practice is that a Host should be miniaturized and simplified. There should not be too many Terminals within a Host."}),"\n",(0,i.jsx)(n.admonition,{type:"warning",children:(0,i.jsx)(n.p,{children:"Never leak the Host token to others. Anyone who knows the Host token can connect to the Host and send messages to Terminals.\nThis can lead to serious security issues and loss of your funds and secrets."})}),"\n",(0,i.jsxs)(n.admonition,{type:"tip",children:[(0,i.jsx)(n.p,{children:"A process can create multiple Terminals to connect to multiple Hosts simultaneously.\nThis is very useful when you want to share data with others but do not want to reveal all your secrets.\nHosts are very lightweight, and you can create a shared Host for a specific purpose at any time.\nWe will introduce how to share information in a limited way later."}),(0,i.jsx)(n.mermaid,{value:"graph LR\n    A[Your Personal Host] <--\x3e B[Your Terminal]\n    B <--\x3e C[Shared Host]\n    C <--\x3e D[Other's Terminal]\n    D <--\x3e E[Other's Personal Host]"})]}),"\n",(0,i.jsx)(n.h3,{id:"terminal-information",children:"Terminal Information"}),"\n",(0,i.jsx)(n.p,{children:"Terminals should declare their Terminal information when connecting to a Host. Terminal information is a JSON object:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export interface ITerminalInfo {\n  terminal_id: string;\n  // Other fields omitted\n}\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"terminal_id"})," is the ID of the Terminal. It should be unique within the Host. This is similar to an IP address."]}),"\n",(0,i.jsx)(n.li,{children:"Terminal information usually includes service information of the Terminal. For example, a Terminal can declare that it provides account information services."}),"\n",(0,i.jsx)(n.li,{children:"Terminal information is used for the Service Mode Layer, which we will introduce later."}),"\n",(0,i.jsx)(n.li,{children:"The Host is responsible for broadcasting Terminal information to all Terminals in a timely manner."}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"message-structure",children:"Message Structure"}),"\n",(0,i.jsx)(n.p,{children:"All messages are JSON-encoded and have the following structure:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export interface ITerminalMessage {\n  source_terminal_id: string;\n  target_terminal_id: string;\n\n  // Other fields for the Service Mode Layer, to be introduced later.\n}\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"source_terminal_id"})," is the ID of the sender Terminal."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"target_terminal_id"})," is the ID of the recipient Terminal."]}),"\n",(0,i.jsxs)(n.li,{children:["The Host reads the ",(0,i.jsx)(n.code,{children:"target_terminal_id"})," and forwards the message to the target Terminal."]}),"\n",(0,i.jsx)(n.li,{children:"Other fields are used for the Service Mode Layer, which we will introduce later."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"optimization",children:"Optimization"}),"\n",(0,i.jsx)(n.p,{children:"The following optimizations are not required by the protocol but implementing them can improve system performance. They are recommended."}),"\n",(0,i.jsx)(n.h3,{id:"optimization-p2p-direct-connection",children:"Optimization: P2P Direct Connection"}),"\n",(0,i.jsx)(n.p,{children:"We can use WebRTC to establish a P2P connection between two Terminals. WebRTC is a peer-to-peer technology that allows Terminals to exchange messages directly. It is a perfect choice for our purpose. Messages do not need to be transmitted through the Host. It is faster and incurs lower traffic costs. When a P2P connection is established, the Host will stop forwarding messages between the two Terminals. In fact, Terminals will no longer send messages to the Host. The operation of the Host has never changed. However, if the P2P connection is interrupted, the Host will resume forwarding messages between the two Terminals."}),"\n",(0,i.jsx)(n.p,{children:"The Host will also forward ICE candidates (offers and answers) between the two Terminals. Therefore, the two Terminals can establish a P2P connection. The Host acts both as a STUN server and a TURN server."}),"\n",(0,i.jsx)(n.p,{children:"Peer connections are established implicitly. When a Terminal sends a message to another Terminal, the Terminal will check if there is a P2P connection with the target Terminal. If not, the Terminal will attempt to establish a P2P connection with the target Terminal. If a P2P connection is established, the Terminal will send the message through the peer connection. If the P2P connection is interrupted, the Terminal will resume sending messages through the Host."}),"\n",(0,i.jsx)(n.h3,{id:"optimization-local-loopback",children:"Optimization: Local Loopback"}),"\n",(0,i.jsx)(n.p,{children:"If the target Terminal of a message points to the Terminal itself, then this message should not be sent over the network but directly to the Terminal's own message channel."}),"\n",(0,i.jsx)(n.p,{children:"This is beneficial for Terminals to subscribe to channels provided by themselves or consume their own services, promoting design decoupling."})]})}function d(e={}){const{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},4317:(e,n,t)=>{t.d(n,{Z:()=>a,a:()=>r});var i=t(3981);const o={},s=i.createContext(o);function r(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);